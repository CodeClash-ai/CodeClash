<!-- Trajectory Container with Overview and Messages -->
<div class="trajectory-header">
    <h3>
        <i class="bi bi-robot"></i> Player {{ trajectory.player_id }} Round {{ round_num }}
    </h3>
    <div class="trajectory-stats">
        <div class="stat-item">
            <span class="stat-label">API Calls:</span>
            <span class="stat-value">{{ trajectory.api_calls }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Cost:</span>
            <span class="stat-value">${{ "%.2f"|format(trajectory.cost) }}</span>
        </div>
        {% if trajectory.exit_status %}
        <div class="stat-item">
            <span class="stat-label">Exit Status:</span>
            <span class="stat-value status-{{ trajectory.exit_status.lower() }}">{{ trajectory.exit_status }}</span>
        </div>
        {% endif %}
        {% if trajectory.valid_submission is not none %}
        <div class="stat-item">
            <span class="stat-label">Valid Submission?</span>
            <span class="stat-value valid-{{ 'yes' if trajectory.valid_submission else 'no' }}">{{ trajectory.valid_submission }}</span>
        </div>
        {% endif %}
    </div>

    <!-- Messages Foldout inside the same container -->
    <details class="trajectory-messages-foldout trajectory-details-foldout"
             data-player="{{ trajectory.player_id }}"
             data-round="{{ trajectory.round_num }}">
        <summary>
            <i class="bi bi-chat"></i> Trajectory
        </summary>
        <div class="trajectory-content">
            {% if is_static and trajectory.messages %}
                {# Static mode: render messages directly #}
                <div class="trajectory-details-content">
                    <div class="trajectory-header-info" style="margin-bottom: 1rem;">
                        <span style="color: var(--muted-text);">{{ trajectory.messages | length }} messages</span>
                    </div>
                    <div class="messages-container">
                        {% for message in trajectory.messages %}
                            {% include 'includes/message.html' %}
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                {# Dynamic mode: lazy load messages #}
                <div class="trajectory-load-placeholder">
                    <button class="btn btn-primary load-trajectory-btn"
                            data-player="{{ trajectory.player_id }}"
                            data-round="{{ trajectory.round_num }}">
                        <i class="bi bi-download"></i> Load Trajectory Messages
                    </button>
                </div>
                <div class="trajectory-loading-spinner" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Loading trajectory data...</span>
                </div>
                <div class="trajectory-details-content" style="display: none;">
                    <div class="trajectory-header-info" style="margin-bottom: 1rem;">
                        <!-- Will be populated with file path and buttons -->
                    </div>
                    <div class="messages-container">
                        <!-- Messages will be loaded here dynamically -->
                    </div>
                    <div class="collapse-messages-button">
                        <button class="btn-collapse-messages">
                            â–² Collapse Messages
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>
    </details>

    <!-- Diff Foldout inside the same container -->
    <details class="trajectory-messages-foldout trajectory-diffs-foldout"
             data-player="{{ trajectory.player_id }}"
             data-round="{{ trajectory.round_num }}">
        <summary><i class="bi bi-file-diff"></i> Diff (Full)</summary>
        <div class="trajectory-content">
            {% if is_static and trajectory.diff_by_files %}
                {# Static mode: render diff directly #}
                <div class="diff-content">
                    {% if trajectory.diff_by_files %}
                        {% for file_path, file_diff in trajectory.diff_by_files.items() %}
                        <details class="file-diff-foldout" open>
                            <summary class="file-diff-header">
                                <i class="bi bi-file-text"></i> {{ file_path }}
                            </summary>
                            <div class="diff-content-wrapper">
                                <pre><code class="diff">{{ file_diff }}</code></pre>
                            </div>
                        </details>
                        {% endfor %}
                    {% else %}
                        <div class="no-diff-message">No diff available</div>
                    {% endif %}
                </div>
            {% else %}
                {# Dynamic mode: lazy load diffs #}
                <div class="diff-load-placeholder">
                    <button class="btn btn-primary load-diffs-btn"
                            data-player="{{ trajectory.player_id }}"
                            data-round="{{ trajectory.round_num }}">
                        <i class="bi bi-download"></i> Load Diff Data
                    </button>
                </div>
                <div class="diff-loading-spinner" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Loading diff data...</span>
                </div>
                <div class="diff-content" style="display: none;">
                    <!-- Content will be loaded dynamically -->
                </div>
            {% endif %}
        </div>
    </details>

    <!-- Incremental Diff Foldout inside the same container -->
    {% if not is_static or (trajectory.incremental_diff_by_files and trajectory.incremental_diff_by_files|length > 0) %}
    <details class="trajectory-messages-foldout trajectory-incremental-diffs-foldout"
             data-player="{{ trajectory.player_id }}"
             data-round="{{ trajectory.round_num }}">
        <summary><i class="bi bi-arrow-repeat"></i> Incremental Diff</summary>
        <div class="trajectory-content">
            {% if is_static and trajectory.incremental_diff_by_files %}
                {# Static mode: render incremental diff directly #}
                <div class="incremental-diff-content">
                    {% for file_path, file_diff in trajectory.incremental_diff_by_files.items() %}
                    <details class="file-diff-foldout" open>
                        <summary class="file-diff-header">
                            <i class="bi bi-file-text"></i> {{ file_path }}
                        </summary>
                        <div class="diff-content-wrapper">
                            <pre><code class="diff">{{ file_diff }}</code></pre>
                        </div>
                    </details>
                    {% endfor %}
                </div>
            {% else %}
                {# Dynamic mode: lazy load diffs #}
                <div class="incremental-diff-load-placeholder">
                    <button class="btn btn-primary load-diffs-btn"
                            data-player="{{ trajectory.player_id }}"
                            data-round="{{ trajectory.round_num }}">
                        <i class="bi bi-download"></i> Load Diff Data
                    </button>
                </div>
                <div class="incremental-diff-content" style="display: none;">
                    <!-- Content will be loaded dynamically -->
                </div>
            {% endif %}
        </div>
    </details>
    {% endif %}

    <!-- Modified Files Foldout inside the same container -->
    <details class="trajectory-messages-foldout trajectory-modified-files-foldout"
             data-player="{{ trajectory.player_id }}"
             data-round="{{ trajectory.round_num }}">
        <summary><i class="bi bi-file-text"></i> Modified Files</summary>
        <div class="trajectory-content">
            {% if is_static and trajectory.modified_files %}
                {# Static mode: render modified files directly #}
                <div class="modified-files-content">
                    {% if trajectory.modified_files %}
                        {% for file_path, file_content in trajectory.modified_files.items() %}
                        <details class="file-content-foldout">
                            <summary class="file-content-header">
                                <i class="bi bi-file-code"></i> {{ file_path }}
                            </summary>
                            <div class="file-content-wrapper">
                                <pre><code>{{ file_content }}</code></pre>
                            </div>
                        </details>
                        {% endfor %}
                    {% else %}
                        <div class="no-files-message">No modified files available</div>
                    {% endif %}
                </div>
            {% else %}
                {# Dynamic mode: lazy load modified files #}
                <div class="modified-files-load-placeholder">
                    <button class="btn btn-primary load-diffs-btn"
                            data-player="{{ trajectory.player_id }}"
                            data-round="{{ trajectory.round_num }}">
                        <i class="bi bi-download"></i> Load Diff Data
                    </button>
                </div>
                <div class="modified-files-content" style="display: none;">
                    <!-- Content will be loaded dynamically -->
                </div>
            {% endif %}
        </div>
    </details>


</div>
